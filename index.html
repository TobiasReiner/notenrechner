<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notenrechner – Deutsch &amp; Mathe</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* Klare, kontrastreiche Farbschemata */
    :root{
      --brand:#0d6efd;
      --brand-light:#e9f2ff;
      --text-dark:#1a2a4a;
    }
    body{
      background:var(--brand-light);
      color:var(--text-dark);
    }
    .navbar{
      background-color:#fff;
      border-bottom:1px solid #e0e4f0;
    }
    .card{
      border:0;
      box-shadow:0 4px 16px rgba(0,0,0,0.05);
      border-radius:12px;
    }
    .chip{
      background-color:var(--brand-light);
      color:var(--brand);
      border-radius:999px;
      padding:.4rem .8rem;
      font-weight:600;
    }
    .sum-ok{ color: #198754; }
    .sum-bad{ color: #dc3545; }
    .note-pill{
      font-weight:700;
      padding:.35rem .7rem;
      border-radius:999px;
      display:inline-block;
    }
    .note-1{ background:#e6f7e6; color:#0b6630; }
    .note-2{ background:#e6effb; color:#11468f; }
    .note-3{ background:#fff7e6; color:#6c5105; }
    .note-4{ background:#ffeae6; color:#9c2c00; }
    .note-5{ background:#fde7eb; color:#850c1a; }
    .table th, .table td{ padding:.35rem .5rem; white-space:nowrap; }
    .table-responsive{ overflow-x:auto; }
    canvas{ max-width:100%; height:auto; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand fw-bold"><i class="bi bi-calculator"></i> Notenrechner</a>
      <div class="d-flex ms-auto align-items-center">
        <a id="paypalDonate" href="https://paypal.me/TobiasReiner793" target="_blank" rel="noopener" aria-label="Spenden an Tobias Reiner" class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1">
          <i class="bi bi-paypal"></i>
          <span class="small">Spenden</span>
        </a>
      </div>
    </div>
  </nav>

  <main class="container my-4 my-md-5">
    <div class="row g-4">
      <div class="col-12">
        <div class="chip"><i class="bi bi-info-circle me-1"></i> Wähle pro Kategorie beliebig viele Zeilen: Punkte, Fehler, Vergessen (HU), Note (1–5), Prozent</div>
      </div>
      <!-- Tabs -->
      <div class="col-12">
        <ul class="nav nav-pills" id="fachTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-de" data-bs-toggle="tab" data-bs-target="#pane-de" type="button" role="tab" aria-controls="pane-de" aria-selected="true">Deutsch</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-ma" data-bs-toggle="tab" data-bs-target="#pane-ma" type="button" role="tab" aria-controls="pane-ma" aria-selected="false">Mathematik</button>
          </li>
        </ul>
      </div>
      <div class="col-12 tab-content">
        <!-- Deutsch-Panel -->
        <div class="tab-pane fade show active" id="pane-de" role="tabpanel" aria-labelledby="tab-de">
          <div class="row g-4">
                <div class="col-12 mb-2">
                  <div class="d-flex gap-2 align-items-center">
                    <label class="mb-0 small fw-semibold">Schüler:</label>
                    <select id="childSelect" class="form-select form-select-sm" style="width:220px"></select>
                    <input id="childNameInput" class="form-control form-control-sm" style="max-width:220px" placeholder="Neuer Schülername" />
                    <button id="btnAddChild" type="button" class="btn btn-sm btn-outline-primary">Hinzufügen</button>
                    <button id="btnSaveChild" type="button" class="btn btn-sm btn-outline-success">Speichern</button>
                    <button id="btnDelChild" type="button" class="btn btn-sm btn-outline-danger">Löschen</button>
                  </div>
                </div>
                <div class="col-lg-7">
              <!-- Gewichtungen -->
              <div class="card p-3 p-md-4">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Gewichtungen (Deutsch)</h5>
                  <span id="sumDE" class="fw-bold sum-bad">Summe: 0 %</span>
                </div>
                <hr>
                <div class="row g-3">
                  <div class="col-12 col-sm-6">
                    <label class="form-label small">Schularbeit</label>
                    <div class="input-group input-group-sm">
                      <input id="wDE_sa" type="number" class="form-control" min="0" max="100" value="40" aria-label="Gewichtung Schularbeit" />
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                  <div class="col-12 col-sm-6">
                    <label class="form-label small">Ansage</label>
                    <div class="input-group input-group-sm">
                      <input id="wDE_ans" type="number" class="form-control" min="0" max="100" value="20" aria-label="Gewichtung Ansage" />
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                  <div class="col-12 col-sm-6">
                    <label class="form-label small">Hausübung</label>
                    <div class="input-group input-group-sm">
                      <input id="wDE_hu" type="number" class="form-control" min="0" max="100" value="20" aria-label="Gewichtung Hausübung" />
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                  <div class="col-12 col-sm-6">
                    <label class="form-label small">Mitarbeit</label>
                    <div class="input-group input-group-sm">
                      <input id="wDE_mi" type="number" class="form-control" min="0" max="100" value="20" aria-label="Gewichtung Mitarbeit" />
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Leistungen Deutsch -->
              <div class="card p-3 p-md-4 mt-4">
                <h5>Leistungen erfassen (Deutsch)</h5>
                <p class="small text-secondary mb-2">Füge Zeilen hinzu, um die Ergebnisse pro Kategorie einzutragen. Der Durchschnitt wird automatisch berechnet.</p>
                <!-- Schularbeit -->
                <div class="mt-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Schularbeit</h6>
                    <button class="btn btn-outline-secondary btn-sm" onclick="addRow('DE','sa')"><i class="bi bi-plus"></i> Zeile</button>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle" id="tblDE_sa" aria-label="Schularbeitstabelle Deutsch">
                      <thead>
                        <tr><th>Art</th><th class="text-end">Erzielt / Fehler / Vergessen</th><th class="text-end">Max. / Gesamt</th><th class="text-end">%</th><th></th></tr>
                      </thead>
                      <tbody></tbody>
                      <tfoot><tr><th colspan="3" class="text-end">Kategorie-Ø</th><th class="text-end"><span id="avgDE_sa">–</span> %</th><th></th></tr></tfoot>
                    </table>
                  </div>
                </div>
                <!-- Ansage -->
                <div class="mt-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Ansage</h6>
                    <button class="btn btn-outline-secondary btn-sm" onclick="addRow('DE','ans')"><i class="bi bi-plus"></i> Zeile</button>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle" id="tblDE_ans" aria-label="Ansagetabelle Deutsch">
                      <thead>
                        <tr><th>Art</th><th class="text-end">Erzielt / Fehler / Vergessen</th><th class="text-end">Max. / Gesamt</th><th class="text-end">%</th><th></th></tr>
                      </thead>
                      <tbody></tbody>
                      <tfoot><tr><th colspan="3" class="text-end">Kategorie-Ø</th><th class="text-end"><span id="avgDE_ans">–</span> %</th><th></th></tr></tfoot>
                    </table>
                  </div>
                </div>
                <!-- Hausübung -->
                <div class="mt-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Hausübung</h6>
                    <button class="btn btn-outline-secondary btn-sm" onclick="addRow('DE','hu','vergessen')"><i class="bi bi-plus"></i> Zeile</button>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle" id="tblDE_hu" aria-label="Hausübungstabelle Deutsch">
                      <thead>
                        <tr><th>Art</th><th class="text-end">Erzielt / Fehler / Vergessen</th><th class="text-end">Max. / Gesamt</th><th class="text-end">%</th><th></th></tr>
                      </thead>
                      <tbody></tbody>
                      <tfoot><tr><th colspan="3" class="text-end">Kategorie-Ø</th><th class="text-end"><span id="avgDE_hu">–</span> %</th><th></th></tr></tfoot>
                    </table>
                  </div>
                </div>
                <!-- Mitarbeit -->
                <div class="mt-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Mitarbeit</h6>
                    <button class="btn btn-outline-secondary btn-sm" onclick="addRow('DE','mi','prozent')"><i class="bi bi-plus"></i> Zeile</button>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle" id="tblDE_mi" aria-label="Mitarbeitstabelle Deutsch">
                      <thead>
                        <tr><th>Art</th><th class="text-end">Erzielt / Fehler / Vergessen</th><th class="text-end">Max. / Gesamt</th><th class="text-end">%</th><th></th></tr>
                      </thead>
                      <tbody></tbody>
                      <tfoot><tr><th colspan="3" class="text-end">Kategorie-Ø</th><th class="text-end"><span id="avgDE_mi">–</span> %</th><th></th></tr></tfoot>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <!-- Ergebnis Deutsch -->
            <div class="col-lg-5">
              <div class="card p-3 p-md-4">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Ergebnis Deutsch</h5>
                  <span id="gradeDE" class="note-pill note-5">–</span>
                </div>
                <hr>
                <div class="row g-3">
                  <div class="col-6">
                    <div class="p-3 bg-white border rounded text-center">
                      <div class="small text-secondary">Gesamt-%</div>
                      <div id="totalPctDE" class="display-6">– %</div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="p-3 bg-white border rounded text-center">
                      <div class="small text-secondary">Gewichtungs-Summe</div>
                      <div id="sumDEmini" class="h3">0 %</div>
                    </div>
                  </div>
                  <div class="col-12"><canvas id="chartDEweights" height="160"></canvas></div>
                  <div class="col-12"><canvas id="chartDEcats" height="160"></canvas></div>
                  <div class="col-12 mt-2"><canvas id="chartDEachieved" height="120"></canvas></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Mathematik-Panel -->
        <div class="tab-pane fade" id="pane-ma" role="tabpanel" aria-labelledby="tab-ma">
          <div class="row g-4">
            <div class="col-lg-7">
              <div class="card p-3 p-md-4">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Gewichtungen (Mathematik)</h5>
                  <span id="sumMA" class="fw-bold sum-bad">Summe: 0 %</span>
                </div>
                <hr>
                <div class="row g-3">
                  <div class="col-12 col-sm-6">
                    <label class="form-label small">Schularbeiten</label>
                    <div class="input-group input-group-sm">
                      <input id="wMA_sa" type="number" class="form-control" min="0" max="100" value="50" aria-label="Gewichtung Schularbeiten" />
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                  <div class="col-12 col-sm-6">
                    <label class="form-label small">LZK</label>
                    <div class="input-group input-group-sm">
                      <input id="wMA_lzk" type="number" class="form-control" min="0" max="100" value="20" aria-label="Gewichtung LZK" />
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                  <div class="col-12 col-sm-6">
                    <label class="form-label small">Hausübung</label>
                    <div class="input-group input-group-sm">
                      <input id="wMA_hu" type="number" class="form-control" min="0" max="100" value="15" aria-label="Gewichtung Hausübung Mathe" />
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                  <div class="col-12 col-sm-6">
                    <label class="form-label small">Mitarbeit</label>
                    <div class="input-group input-group-sm">
                      <input id="wMA_mi" type="number" class="form-control" min="0" max="100" value="15" aria-label="Gewichtung Mitarbeit Mathe" />
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Leistungen Mathe -->
              <div class="card p-3 p-md-4 mt-4">
                <h5>Leistungen erfassen (Mathematik)</h5>
                <p class="small text-secondary mb-2">Auch hier beliebig viele Einträge pro Kategorie. Der Durchschnitt wird aus allen Zeilen berechnet.</p>
                <!-- SA -->
                <div class="mt-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Schularbeiten</h6>
                    <button class="btn btn-outline-secondary btn-sm" onclick="addRow('MA','sa')"><i class="bi bi-plus"></i> Zeile</button>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle" id="tblMA_sa" aria-label="Schularbeitstabelle Mathe">
                      <thead><tr><th>Art</th><th class="text-end">Erzielt / Fehler / Vergessen</th><th class="text-end">Max. / Gesamt</th><th class="text-end">%</th><th></th></tr></thead>
                      <tbody></tbody>
                      <tfoot><tr><th colspan="3" class="text-end">Kategorie-Ø</th><th class="text-end"><span id="avgMA_sa">–</span> %</th><th></th></tr></tfoot>
                    </table>
                  </div>
                </div>
                <!-- LZK -->
                <div class="mt-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">LZK</h6>
                    <button class="btn btn-outline-secondary btn-sm" onclick="addRow('MA','lzk')"><i class="bi bi-plus"></i> Zeile</button>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle" id="tblMA_lzk" aria-label="LZK Tabelle Mathe">
                      <thead><tr><th>Art</th><th class="text-end">Erzielt / Fehler / Vergessen</th><th class="text-end">Max. / Gesamt</th><th class="text-end">%</th><th></th></tr></thead>
                      <tbody></tbody>
                      <tfoot><tr><th colspan="3" class="text-end">Kategorie-Ø</th><th class="text-end"><span id="avgMA_lzk">–</span> %</th><th></th></tr></tfoot>
                    </table>
                  </div>
                </div>
                <!-- HU -->
                <div class="mt-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Hausübung</h6>
                    <button class="btn btn-outline-secondary btn-sm" onclick="addRow('MA','hu','vergessen')"><i class="bi bi-plus"></i> Zeile</button>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle" id="tblMA_hu" aria-label="Hausübungstabelle Mathe">
                      <thead><tr><th>Art</th><th class="text-end">Erzielt / Fehler / Vergessen</th><th class="text-end">Max. / Gesamt</th><th class="text-end">%</th><th></th></tr></thead>
                      <tbody></tbody>
                      <tfoot><tr><th colspan="3" class="text-end">Kategorie-Ø</th><th class="text-end"><span id="avgMA_hu">–</span> %</th><th></th></tr></tfoot>
                    </table>
                  </div>
                </div>
                <!-- Mitarbeit -->
                <div class="mt-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Mitarbeit</h6>
                    <button class="btn btn-outline-secondary btn-sm" onclick="addRow('MA','mi','prozent')"><i class="bi bi-plus"></i> Zeile</button>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle" id="tblMA_mi" aria-label="Mitarbeitstabelle Mathe">
                      <thead><tr><th>Art</th><th class="text-end">Erzielt / Fehler / Vergessen</th><th class="text-end">Max. / Gesamt</th><th class="text-end">%</th><th></th></tr></thead>
                      <tbody></tbody>
                      <tfoot><tr><th colspan="3" class="text-end">Kategorie-Ø</th><th class="text-end"><span id="avgMA_mi">–</span> %</th><th></th></tr></tfoot>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <!-- Ergebnis Mathe -->
            <div class="col-lg-5">
              <div class="card p-3 p-md-4">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Ergebnis Mathe</h5>
                  <span id="gradeMA" class="note-pill note-5">–</span>
                </div>
                <hr>
                <div class="row g-3">
                  <div class="col-6">
                    <div class="p-3 bg-white border rounded text-center">
                      <div class="small text-secondary">Gesamt-%</div>
                      <div id="totalPctMA" class="display-6">– %</div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="p-3 bg-white border rounded text-center">
                      <div class="small text-secondary">Gewichtungs-Summe</div>
                      <div id="sumMAmini" class="h3">0 %</div>
                    </div>
                  </div>
                  <div class="col-12"><canvas id="chartMAweights" height="160"></canvas></div>
                  <div class="col-12"><canvas id="chartMAcats" height="160"></canvas></div>
                  <div class="col-12 mt-2"><canvas id="chartMAachieved" height="120"></canvas></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="mt-4">
      <div class="d-flex gap-2 flex-wrap mb-2">
        <button id="btnExportCSV" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Export (CSV)</button>
        <button id="btnImportCSV" class="btn btn-sm btn-outline-secondary"><i class="bi bi-upload"></i> Import (CSV)</button>
        <button id="btnPrint" class="btn btn-sm btn-outline-success"><i class="bi bi-file-earmark-pdf"></i> Als PDF</button>
        <button id="btnReset" class="btn btn-sm btn-outline-danger"><i class="bi bi-x-circle"></i> Zurücksetzen</button>
      </div>
      <div class="chip">
        <i class="bi bi-question-circle"></i> Punkte: <em>erzielt / maximal</em> · Fehler: <em>Fehler / Gesamtaufgaben</em> · Vergessen (HU): <em>vergessen / vergebene</em> · Note 1–5 → Prozent (über Schwellen)
      </div>
      <input id="fileImport" type="file" accept="text/csv,text/plain" style="display:none" />
    </div>
  </main>

  <!-- Modal für Notenschwellen -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Bewertungsschwellen (Notenskala)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>
        <div class="modal-body">
          <p class="small text-secondary mb-2">Passe hier die Grenze (in Prozent) an, ab der die jeweilige Note erreicht wird. Unterhalb der Note-4-Grenze wird die Note 5 vergeben.</p>
          <div class="row g-3">
            <div class="col-6">
              <label class="form-label small">Note 1 ab (%)</label>
              <input id="thr1" type="number" min="0" max="100" value="90" class="form-control" />
            </div>
            <div class="col-6">
              <label class="form-label small">Note 2 ab (%)</label>
              <input id="thr2" type="number" min="0" max="100" value="80" class="form-control" />
            </div>
            <div class="col-6">
              <label class="form-label small">Note 3 ab (%)</label>
              <input id="thr3" type="number" min="0" max="100" value="65" class="form-control" />
            </div>
            <div class="col-6">
              <label class="form-label small">Note 4 ab (%)</label>
              <input id="thr4" type="number" min="0" max="100" value="50" class="form-control" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" data-bs-dismiss="modal" onclick="recalcAll()">Übernehmen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Zeilenvorlage -->
  <template id="rowTemplate">
    <tr>
      <td>
        <select class="form-select form-select-sm typeSel">
          <option value="punkte">Punkte</option>
          <option value="fehler">Fehler</option>
          <option value="vergessen">Vergessen (HU)</option>
          <option value="note">Note (1–5)</option>
          <option value="prozent">Prozent</option>
        </select>
      </td>
      <td class="text-end"><input type="number" class="form-control form-control-sm valA" placeholder="…" /></td>
      <td class="text-end"><input type="number" class="form-control form-control-sm valB" placeholder="…" /></td>
      <td class="text-end fw-semibold"><span class="pct">–</span> %</td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger" title="Zeile entfernen"><i class="bi bi-trash"></i></button></td>
    </tr>
  </template>

  <script>
    // Hilfsfunktionen
    const el = id => document.getElementById(id);
    const f2 = n => (isFinite(n)? n.toFixed(1) : "–");
    const clamp = (v,min,max) => Math.max(min, Math.min(max, v));

    // Notenschwellen
    const thresholds = { n1:90, n2:80, n3:65, n4:50 };
    function pct2note(p){
      if (!isFinite(p)) return 5;
      if (p >= thresholds.n1) return 1;
      if (p >= thresholds.n2) return 2;
      if (p >= thresholds.n3) return 3;
      if (p >= thresholds.n4) return 4;
      return 5;
    }
    function noteClass(n){ return `note-${clamp(n,1,5)}`; }

    // Global error handlers to surface problems during development
    window.addEventListener('error', function(e){
      try{ console.error('Unhandled error', e); alert('JavaScript-Fehler: '+e.message+'\nSiehe Konsole für Details.'); }catch(_){ }
    });
    window.addEventListener('unhandledrejection', function(e){
      try{ console.error('Unhandled rejection', e); alert('Promise-Rejection: '+(e.reason && e.reason.message ? e.reason.message : e.reason)); }catch(_){ }
    });

    // Prozentberechnung pro Zeile
    function rowToPercent(type, a, b){
      const x = parseFloat(a), y = parseFloat(b);
      switch(type){
        case 'punkte':
          if (y>0) return clamp(100 * x / y, 0, 100);
          return NaN;
        case 'fehler':
          if (y>0) return clamp(100 * (1 - x / y), 0, 100);
          return NaN;
        case 'vergessen':
          if (y>0) return clamp(100 * (1 - x / y), 0, 100);
          return NaN;
        case 'note':
          const n = clamp(Math.round(x),1,5);
          const {n1,n2,n3,n4} = thresholds;
          const map = {
            1:(n1+100)/2,
            2:(n2+n1)/2,
            3:(n3+n2)/2,
            4:(n4+n3)/2,
            5:(0+n4)/2
          };
          return clamp(map[n],0,100);
        case 'prozent':
          return clamp(x,0,100);
        default:
          return NaN;
      }
    }

    // Zeile hinzufügen
    function addRow(fach, cat, preferredType){
      const table = el(`tbl${fach}_${cat}`).querySelector('tbody');
      const tpl = document.getElementById('rowTemplate').content.cloneNode(true);
      const tr = tpl.querySelector('tr');
      const typeSel = tr.querySelector('.typeSel');
      const valA = tr.querySelector('.valA');
      const valB = tr.querySelector('.valB');
      const pctSpan = tr.querySelector('.pct');
      const delBtn = tr.querySelector('button');

      if (preferredType){ typeSel.value = preferredType; }
      adaptInputs();

      function adaptInputs(){
        const t = typeSel.value;
        valA.disabled=false;
        valB.disabled=false;
        if (t==='punkte'){ valA.placeholder='erzielt'; valB.placeholder='max.'; }
        else if (t==='fehler'){ valA.placeholder='Fehler'; valB.placeholder='gesamt'; }
        else if (t==='vergessen'){ valA.placeholder='vergessen'; valB.placeholder='vergeben'; }
        else if (t==='note'){ valA.placeholder='1–5'; valB.value=''; valB.placeholder='—'; valB.disabled=true; }
        else if (t==='prozent'){ valA.placeholder='%'; valB.value=''; valB.placeholder='—'; valB.disabled=true; }
        compute();
      }
      function compute(){
        const t = typeSel.value;
        const p = rowToPercent(t, valA.value, valB.value);
        pctSpan.textContent = isFinite(p) ? f2(p) : '–';
        recalcAll();
      }
      typeSel.addEventListener('change', adaptInputs);
  [valA,valB].forEach(x=>{ x.addEventListener('input', compute); x.addEventListener('change', compute); });
      delBtn.addEventListener('click',()=>{ tr.remove(); recalcAll(); });

      table.appendChild(tr);
    }

    // Gewichtungen lesen
    function readWeights(f){
      if (f==='DE'){
        return { sa: parseFloat(el('wDE_sa').value)||0, ans: parseFloat(el('wDE_ans').value)||0, hu: parseFloat(el('wDE_hu').value)||0, mi: parseFloat(el('wDE_mi').value)||0 };
      } else {
        return { sa: parseFloat(el('wMA_sa').value)||0, lzk: parseFloat(el('wMA_lzk').value)||0, hu: parseFloat(el('wMA_hu').value)||0, mi: parseFloat(el('wMA_mi').value)||0 };
      }
    }

    // Kategorie-Durchschnitt
    function catAvg(f, cat){
      const rows = el(`tbl${f}_${cat}`).querySelectorAll('tbody tr');
      let sum=0, n=0;
      rows.forEach(r=>{
        const t = r.querySelector('.typeSel').value;
        const a = r.querySelector('.valA').value;
        const b = r.querySelector('.valB').value;
        const p = rowToPercent(t, a, b);
        // update per-row percent display so UI stays in sync
        const pctSpan = r.querySelector('.pct');
        if (pctSpan) pctSpan.textContent = isFinite(p) ? f2(p) : '–';
        if (isFinite(p)){ sum+=p; n++; }
      });
      const avg = n ? sum / n : NaN;
      el(`avg${f}_${cat}`).textContent = isFinite(avg)? f2(avg) : '–';
      return avg;
    }

    // Gesamtergebnisse berechnen
    function calcTotals(f){
      const weights = readWeights(f);
      const cats = f==='DE' ? ['sa','ans','hu','mi'] : ['sa','lzk','hu','mi'];
      let wsum=0, acc=0;
      cats.forEach(c=>{
        const w = weights[c]||0;
        const avg = catAvg(f, c);
        if (isFinite(avg) && w>0){ acc += avg * (w/100); }
        wsum += w;
      });
      return { total: (wsum===100? acc : NaN), wsum, partial: acc };
    }

    // Ergebnis-UI aktualisieren
    function updateSummary(f){
      const { total, wsum, partial } = calcTotals(f);
      const sumEl = el(f==='DE' ? 'sumDE' : 'sumMA');
      const miniEl = el(f==='DE' ? 'sumDEmini' : 'sumMAmini');
      sumEl.textContent = `Summe: ${wsum} %`;
      miniEl.textContent = `${wsum} %`;
      sumEl.classList.toggle('sum-ok', wsum===100);
      sumEl.classList.toggle('sum-bad', wsum!==100);
      const totalPctEl = el(f==='DE' ? 'totalPctDE' : 'totalPctMA');
      const gradeEl = el(f==='DE' ? 'gradeDE' : 'gradeMA');
      // Always show the weighted partial total. If weights don't sum to 100, indicate it visually.
      const pct = isFinite(partial) ? partial : NaN;
      totalPctEl.textContent = isFinite(pct) ? `${f2(pct)} %` : '– %';
      if (isFinite(pct)){
        const note = pct2note(pct);
        gradeEl.className = `note-pill ${noteClass(note)}`;
        gradeEl.textContent = `Note ${note}`;
        // de-emphasize if weights incomplete
        gradeEl.style.opacity = (wsum===100 ? '1' : '0.6');
        gradeEl.title = (wsum===100 ? '' : 'Gewichtungen ergeben nicht 100 % — Ergebnis ist nur teilweise aussagekräftig');
      } else {
        gradeEl.className = `note-pill ${noteClass(5)}`;
        gradeEl.textContent = '–';
        gradeEl.style.opacity = '1';
        gradeEl.title = '';
      }
      updateCharts(f, readWeights(f));
    }

    // Alles neu berechnen
    function recalcAll(){
      thresholds.n1 = parseFloat(el('thr1').value)||thresholds.n1;
      thresholds.n2 = parseFloat(el('thr2').value)||thresholds.n2;
      thresholds.n3 = parseFloat(el('thr3').value)||thresholds.n3;
      thresholds.n4 = parseFloat(el('thr4').value)||thresholds.n4;
      updateSummary('DE');
      updateSummary('MA');
    }

    // ensure every recalculation persists to active child
    const __origRecalcAll = recalcAll;
    recalcAll = function(){ __origRecalcAll(); try{ const active = localStorage.getItem(ACTIVE_CHILD_KEY) || el('childSelect')?.value; if (active) localStorage.setItem(stateKeyFor(active), JSON.stringify(buildCurrentState())); }catch(e){ console.warn('save on recalc failed', e); } };

    // Charts
  const charts = { DE:{ w:null, c:null, a:null }, MA:{ w:null, c:null, a:null } };
    function updateCharts(f, weights){
      const cats = f==='DE' ? ['sa','ans','hu','mi'] : ['sa','lzk','hu','mi'];
      const labelMap = { sa: f==='DE'?'Schularbeit(en)':'Schularbeiten', ans:'Ansage', hu:'Hausübung', mi:'Mitarbeit', lzk:'LZK' };
      const labels = cats.map(k=>labelMap[k]);
      const weightVals = cats.map(k=>weights[k]||0);
      const catVals = cats.map(k=>{
        const txt = el(`avg${f}_${k}`).textContent.replace(',', '.');
        const num = parseFloat(txt);
        return isFinite(num) ? num : 0;
      });
  const wCanvas = el(f==='DE'?'chartDEweights':'chartMAweights');
  const cCanvas = el(f==='DE'?'chartDEcats':'chartMAcats');
  const aCanvas = el(f==='DE'?'chartDEachieved':'chartMAachieved');
      if (charts[f].w) charts[f].w.destroy();
      charts[f].w = new Chart(wCanvas, {
        type:'doughnut',
        data:{ labels: labels, datasets:[{ data: weightVals, backgroundColor:[ '#0d6efd', '#0dcaf0', '#ffc107', '#198754' ] }]},
        options:{ plugins:{ legend:{ position:'bottom' }, title:{ display:true, text:'Gewichtungs-Verteilung' } }, cutout:'60%' }
      });
      if (charts[f].c) charts[f].c.destroy();
      charts[f].c = new Chart(cCanvas, {
        type:'bar',
        data:{ labels: labels, datasets:[{ label:'Kategorie-Ø (%)', data: catVals, backgroundColor:'#0d6efd' }]},
        options:{ plugins:{ legend:{ display:false }, title:{ display:true, text:'Kategorien-Durchschnitte' } }, scales:{ y:{ beginAtZero:true, max:100 } } }
      });
      // achieved vs missing chart (stacked)
      const achieved = catVals;
      const missing = achieved.map((v,idx)=> Math.max(0, 100 - (v||0)));
      if (charts[f].a) charts[f].a.destroy();
      charts[f].a = new Chart(aCanvas, {
        type:'bar',
        data:{ labels: labels, datasets:[{ label:'Erreicht', data: achieved, backgroundColor:'#198754' }, { label:'Fehlt', data: missing, backgroundColor:'rgba(25,135,84,0.25)' }]},
        options:{ plugins:{ legend:{ position:'bottom' }, title:{ display:true, text:'Erreichte vs. fehlende Prozent' } }, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true, max:100 } } }
      });
    }

    function bindWeightInputs(){
      ['wDE_sa','wDE_ans','wDE_hu','wDE_mi','wMA_sa','wMA_lzk','wMA_hu','wMA_mi'].forEach(id=>{
        const e = el(id);
        if (!e) return;
        e.addEventListener('input', recalcAll);
        e.addEventListener('change', recalcAll);
      });
    }

    function seedRows(){
      // Deutsch
      addRow('DE','sa','punkte');
      addRow('DE','ans','punkte');
      addRow('DE','hu','vergessen');
      addRow('DE','mi','prozent');
      // Mathe
      addRow('MA','sa','punkte');
      addRow('MA','lzk','fehler');
      addRow('MA','hu','vergessen');
      addRow('MA','mi','prozent');
      // Beispielwerte
      const fill = (tblId,a,b) => {
        const row = document.querySelector(`#${tblId} tbody tr`);
        if (row){
          row.querySelector('.valA').value=a;
          const vb = row.querySelector('.valB');
          if (!vb.disabled) vb.value=b;
        }
      };
      fill('tblDE_sa',45,50);
      fill('tblDE_ans',18,20);
      fill('tblDE_hu',1,10);
      fill('tblDE_mi',85,0);
      fill('tblMA_sa',40,50);
      document.querySelector('#tblMA_lzk tbody tr .typeSel').value='fehler';
      fill('tblMA_lzk',3,20);
      fill('tblMA_hu',2,10);
      fill('tblMA_mi',90,0);
      recalcAll();
    }

    // --- Kinderverwaltung ---
    const CHILD_LIST_KEY = 'notenChildren';
    const ACTIVE_CHILD_KEY = 'notenActiveChild';

    function loadChildList(){
      try{ const raw = localStorage.getItem(CHILD_LIST_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; }
    }
    function saveChildList(list){ localStorage.setItem(CHILD_LIST_KEY, JSON.stringify(list)); }

    function renderChildSelect(){
      const sel = el('childSelect'); sel.innerHTML='';
      const list = loadChildList();
      list.forEach(name=>{ const o = document.createElement('option'); o.value = name; o.textContent = name; sel.appendChild(o); });
  const active = localStorage.getItem(ACTIVE_CHILD_KEY) || list[0] || null;
  if (active) sel.value = active;
  sel.onchange = ()=>{ localStorage.setItem(ACTIVE_CHILD_KEY, sel.value); loadStateForChild(sel.value); };
    }

    function ensureDefaultChild(){ const list = loadChildList(); if (!list.length){ list.push('Schüler 1'); saveChildList(list); localStorage.setItem(ACTIVE_CHILD_KEY, list[0]); } }

    function createEmptyState(){ const state = { weights:{ DE: readWeights('DE'), MA: readWeights('MA') }, thresholds: { thr1: thresholds.n1, thr2: thresholds.n2, thr3: thresholds.n3, thr4: thresholds.n4 }, rows: [] }; return state; }

    function addChild(name){ if (!name) return; const list = loadChildList(); if (list.includes(name)){ alert('Name bereits vorhanden'); return; } // create empty state for child
      const state = createEmptyState(); localStorage.setItem(stateKeyFor(name), JSON.stringify(state)); list.push(name); saveChildList(list); localStorage.setItem(ACTIVE_CHILD_KEY, name); renderChildSelect(); loadStateForChild(name); }
    function delChild(name){ if (!name) return; let list = loadChildList(); if (!list.includes(name)) return; if (!confirm(`Schüler "${name}" wirklich löschen? (inkl. Daten)`)) return; list = list.filter(x=>x!==name); saveChildList(list); localStorage.removeItem(stateKeyFor(name)); if (list.length) localStorage.setItem(ACTIVE_CHILD_KEY, list[0]); else localStorage.removeItem(ACTIVE_CHILD_KEY); renderChildSelect(); const nxt = localStorage.getItem(ACTIVE_CHILD_KEY); if (nxt) loadStateForChild(nxt); else { // clear UI
      ['DE','MA'].forEach(f=>{ const cats = f==='DE'?['sa','ans','hu','mi']:['sa','lzk','hu','mi']; cats.forEach(cat=> el(`tbl${f}_${cat}`).querySelector('tbody').innerHTML=''); });
    } }

    function stateKeyFor(child){ return `notenState__${child}`; }

    function saveStateForChild(child){ try{ const rawState = buildCurrentState(); localStorage.setItem(stateKeyFor(child), JSON.stringify(rawState)); // also ensure child is listed
        const list = loadChildList(); if (!list.includes(child)){ list.push(child); saveChildList(list); } }catch(e){ console.warn(e); } }

    function loadStateForChild(child){ try{ const raw = localStorage.getItem(stateKeyFor(child)); if (!raw) { // nothing saved for child -> seed
          // clear rows and seed default rows
          ['DE','MA'].forEach(f=>{ const cats = f==='DE'?['sa','ans','hu','mi']:['sa','lzk','hu','mi']; cats.forEach(cat=> el(`tbl${f}_${cat}`).querySelector('tbody').innerHTML=''); });
      seedRows(); localStorage.setItem(ACTIVE_CHILD_KEY, child); return; }
        const state = JSON.parse(raw);
        // apply
        if (state.weights){ if (state.weights.DE) Object.entries(state.weights.DE).forEach(([k,v])=>{ const elid='wDE_'+k; if (el(elid)) el(elid).value = v; }); if (state.weights.MA) Object.entries(state.weights.MA).forEach(([k,v])=>{ const elid='wMA_'+k; if (el(elid)) el(elid).value = v; }); }
        if (state.thresholds){ el('thr1').value = state.thresholds.thr1; el('thr2').value = state.thresholds.thr2; el('thr3').value = state.thresholds.thr3; el('thr4').value = state.thresholds.thr4; }
        ['DE','MA'].forEach(f=>{ const cats = f==='DE'?['sa','ans','hu','mi']:['sa','lzk','hu','mi']; cats.forEach(cat=> el(`tbl${f}_${cat}`).querySelector('tbody').innerHTML=''); });
        if (Array.isArray(state.rows) && state.rows.length){
          state.rows.forEach(r=>{ addRow(r.fach, r.cat, r.type); const last = el(`tbl${r.fach}_${r.cat}`).querySelector('tbody tr:last-child'); if (last){ last.querySelector('.valA').value = r.a; const vb = last.querySelector('.valB'); if (!vb.disabled) vb.value = r.b; } });
        } else {
          // ensure at least one editable row per category
          ['DE','MA'].forEach(f=>{ const cats = f==='DE'?['sa','ans','hu','mi']:['sa','lzk','hu','mi']; cats.forEach(cat=>{ const tb = el(`tbl${f}_${cat}`).querySelector('tbody'); if (!tb.querySelector('tr')){
              // choose preferred type per category
              const pref = (f==='DE' && cat==='mi') || (f==='MA' && cat==='mi') ? 'prozent' : (cat==='hu' ? 'vergessen' : (cat==='lzk' ? 'fehler' : 'punkte'));
              addRow(f, cat, pref);
            } }); });
        }
        recalcAll(); localStorage.setItem(ACTIVE_CHILD_KEY, child);
      }catch(e){ console.warn('loadStateForChild failed', e); }
    }

    function buildCurrentState(){ const state = { weights: {}, thresholds: {}, rows: [] }; ['DE','MA'].forEach(f=>{ state.weights[f]=readWeights(f); }); state.thresholds = { thr1: parseFloat(el('thr1').value)||thresholds.n1, thr2: parseFloat(el('thr2').value)||thresholds.n2, thr3: parseFloat(el('thr3').value)||thresholds.n3, thr4: parseFloat(el('thr4').value)||thresholds.n4 };
      const faculties = [ ['DE',['sa','ans','hu','mi']], ['MA',['sa','lzk','hu','mi']] ]; faculties.forEach(([f,cats])=>{ cats.forEach(cat=>{ const rows = el(`tbl${f}_${cat}`).querySelectorAll('tbody tr'); rows.forEach(r=>{ const t = r.querySelector('.typeSel').value; const a = r.querySelector('.valA').value; const b = r.querySelector('.valB').value; state.rows.push({ fach:f, cat, type:t, a, b }); }); }); }); return state; }

    // override save/load to be per-active-child
    function saveState(){ try{ const active = localStorage.getItem(ACTIVE_CHILD_KEY) || el('childSelect').value; if (!active){ console.warn('No active child to save'); return; } const state = buildCurrentState(); localStorage.setItem(stateKeyFor(active), JSON.stringify(state)); // also keep child list
        const list = loadChildList(); if (!list.includes(active)){ list.push(active); saveChildList(list); renderChildSelect(); }
      }catch(e){ console.warn('Save failed', e); } }

    function loadState(){ try{ renderChildSelect(); ensureDefaultChild(); const active = localStorage.getItem(ACTIVE_CHILD_KEY) || el('childSelect').value; if (!active) return false; loadStateForChild(active); return true; }catch(e){ console.warn(e); return false; } }

    // wire child buttons
    function bindChildButtons(){
      const add = el('btnAddChild'); const del = el('btnDelChild');
      if (add) add.addEventListener('click', ()=>{
        try{
          const name = (el('childNameInput').value||'').trim();
          if (!name) return alert('Bitte Namen eingeben');
          addChild(name);
          el('childNameInput').value='';
        }catch(e){ console.error('add child failed', e); alert('Fehler beim Hinzufügen'); }
      });
      const saveBtn = el('btnSaveChild'); if (saveBtn) saveBtn.addEventListener('click', ()=>{ try{ const active = localStorage.getItem(ACTIVE_CHILD_KEY) || el('childSelect')?.value; if (!active) return alert('Kein aktiver Schüler zum Speichern'); saveState(); alert('Daten gespeichert.'); }catch(e){ console.error('save child failed', e); alert('Fehler beim Speichern'); } });
      if (del) del.addEventListener('click', ()=>{
        try{
          const sel = el('childSelect'); if (!sel || !sel.value) return alert('Kein Schüler ausgewählt');
          delChild(sel.value);
        }catch(e){ console.error('delete child failed', e); alert('Fehler beim Löschen'); }
      });
    }

    // update export/import to include child-key metadata
    exportCSV = function(){ const child = localStorage.getItem(ACTIVE_CHILD_KEY) || el('childSelect').value || 'unknown'; const raw = localStorage.getItem(stateKeyFor(child)); const lines=['notenrechner-csv,v1','CH,'+child]; if (raw){ const s=JSON.parse(raw); if (s.thresholds) lines.push(`T,thr1,${s.thresholds.thr1}`), lines.push(`T,thr2,${s.thresholds.thr2}`), lines.push(`T,thr3,${s.thresholds.thr3}`), lines.push(`T,thr4,${s.thresholds.thr4}`); if (s.weights) Object.entries(s.weights).forEach(([fach,obj])=>{ Object.entries(obj).forEach(([k,v])=>{ lines.push(`W,${fach},${k},${v}`); }); }); if (Array.isArray(s.rows)) s.rows.forEach(r=>{ lines.push(`R,${r.fach},${r.cat},${r.type},${(r.a||'')},${(r.b||'')}`); }); }
      const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download = `notenexport_${child.replace(/[^a-z0-9_-]/ig,'_')}.csv`; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },5000);
    };

    // adapt import to load into current or new child if CH line present
    importCSVText = function(text){ const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); if (!lines.length) return alert('Leere Datei'); let targetChild = null; if (lines[0].startsWith('notenrechner-csv')){ if (lines[1] && lines[1].startsWith('CH,')){ targetChild = lines[1].split(',')[1]; } }
      // if no child specified, ask whether to import to current
      if (!targetChild){ if (!confirm('Keine Schülerinformation gefunden. In aktuellen Schüler importieren? (Abbrechen = neuen Schüler anlegen)')){ const name = prompt('Name des neuen Schülers:'); if (!name) return; targetChild = name; } else { targetChild = localStorage.getItem(ACTIVE_CHILD_KEY) || el('childSelect').value; } }
      // parse the rest using original logic but building state
      const state = { weights:{ DE:{}, MA:{} }, thresholds:{}, rows:[] };
      lines.forEach(l=>{ const parts=l.split(','); const t=parts[0]; if (t==='CH') return; if (t==='T') state.thresholds[parts[1]] = parseFloat(parts[2]); else if (t==='W'){ const fach=parts[1], key=parts[2], val=parseFloat(parts[3])||0; state.weights[fach]=state.weights[fach]||{}; state.weights[fach][key]=val; } else if (t==='R'){ const [, fach, cat, type, a, b] = parts; state.rows.push({ fach, cat, type, a:a||'', b:b||'' }); } });
      // save to child key
      localStorage.setItem(stateKeyFor(targetChild), JSON.stringify(state)); // ensure child exists
      const list = loadChildList(); if (!list.includes(targetChild)){ list.push(targetChild); saveChildList(list); }
      renderChildSelect(); localStorage.setItem(ACTIVE_CHILD_KEY, targetChild); loadStateForChild(targetChild); alert('Import abgeschlossen.'); };


    document.addEventListener('DOMContentLoaded',()=>{
      try{
      console.log('notenrechner init');
      bindWeightInputs();
      // Kinderverwaltung initialisieren
      ensureDefaultChild();
      renderChildSelect();
      bindChildButtons();
      // Versuche gespeicherten Zustand zu laden (für aktiven Schüler), ansonsten initialisieren
      if (!loadState()){
        seedRows();
      }
      // Buttons
      document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
      document.getElementById('btnImportCSV').addEventListener('click', ()=>document.getElementById('fileImport').click());
      document.getElementById('fileImport').addEventListener('change', e=>{
        const f = e.target.files[0];
        if (f) importCSVFile(f);
        e.target.value = '';
      });
      document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
      document.getElementById('btnReset').addEventListener('click', ()=>{ if (confirm('Gespeicherte Daten löschen und zurücksetzen?')){ // clear all child data
          const list = loadChildList(); list.forEach(n=>localStorage.removeItem(stateKeyFor(n))); localStorage.removeItem(CHILD_LIST_KEY); localStorage.removeItem(ACTIVE_CHILD_KEY); location.reload(); }});
      }catch(err){ console.error('init failed', err); alert('Initialisierung fehlgeschlagen: '+err.message); }
    });
    
    
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Backup import/export functions and UI injection -->
  <script>
    // Export all child data as a JSON backup file
    function exportBackup() {
      try {
        const childList = JSON.parse(localStorage.getItem(CHILD_LIST_KEY) || "[]");
        const backupData = {};
        childList.forEach(child => {
          const stateRaw = localStorage.getItem(stateKeyFor(child));
          if (stateRaw) {
            backupData[child] = JSON.parse(stateRaw);
          }
        });
        const blob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'notenrechner-backup.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error('Backup export failed', err);
        alert('Fehler beim Exportieren des Backups');
      }
    }

    // Import backup data from JSON text into localStorage, merging with existing children
    function importBackupText(text) {
      try {
        const data = JSON.parse(text);
        let list = JSON.parse(localStorage.getItem(CHILD_LIST_KEY) || "[]");
        Object.keys(data).forEach(origName => {
          let name = origName;
          let counter = 1;
          while (list.includes(name)) {
            name = origName + ' (Import ' + counter + ')';
            counter++;
          }
          list.push(name);
          localStorage.setItem(stateKeyFor(name), JSON.stringify(data[origName]));
        });
        localStorage.setItem(CHILD_LIST_KEY, JSON.stringify(list));
        // refresh UI
        renderChildSelect();
        loadChildList();
      } catch (err) {
        console.error('Backup import failed', err);
        alert('Fehler beim Importieren des Backups');
      }
    }

    // Read a backup file and call importBackupText
    function importBackupFile(file) {
      const reader = new FileReader();
      reader.onload = e => {
        importBackupText(e.target.result);
      };
      reader.onerror = () => {
        alert('Fehler beim Lesen der Backup-Datei');
      };
      reader.readAsText(file);
    }

    // Inject backup buttons into the UI and wire event handlers
    document.addEventListener('DOMContentLoaded', () => {
      const exportCSVBtn = document.getElementById('btnExportCSV');
      // Only inject if there is an export CSV button present
      if (exportCSVBtn) {
        const parent = exportCSVBtn.parentNode;
        // Backup export button
        const btnExportBackup = document.createElement('button');
        btnExportBackup.id = 'btnExportBackup';
        btnExportBackup.className = 'btn btn-sm btn-outline-primary';
        btnExportBackup.innerHTML = '<i class=\"bi bi-download\"></i> Backup (JSON)';
        parent.insertBefore(btnExportBackup, exportCSVBtn.nextSibling);
        btnExportBackup.addEventListener('click', exportBackup);

        // Backup import button
        const btnImportBackup = document.createElement('button');
        btnImportBackup.id = 'btnImportBackup';
        btnImportBackup.className = 'btn btn-sm btn-outline-primary';
        btnImportBackup.innerHTML = '<i class=\"bi bi-upload\"></i> Backup laden';
        parent.insertBefore(btnImportBackup, btnExportBackup.nextSibling);

        // Hidden file input for backup import
        const fileImportBackup = document.createElement('input');
        fileImportBackup.id = 'fileImportBackup';
        fileImportBackup.type = 'file';
        fileImportBackup.accept = '.json,application/json';
        fileImportBackup.style.display = 'none';
        parent.insertBefore(fileImportBackup, btnImportBackup.nextSibling);

        // Wire import button to trigger file input
        btnImportBackup.addEventListener('click', () => {
          fileImportBackup.click();
        });
        // Handle file selection
        fileImportBackup.addEventListener('change', e => {
          const file = e.target.files[0];
          if (file) {
            importBackupFile(file);
          }
          e.target.value = '';
        });
      }
    });
  </script>
</body>
</html>
