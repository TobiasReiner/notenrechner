<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notenrechner</title>
    <!-- Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        padding: 2rem;
        background: #f5f5f5;
      }
      h1 {
        margin-bottom: 1rem;
        text-align: center;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
      }
      th,
      td {
        padding: 0.5rem;
        border: 1px solid #ccc;
        text-align: left;
      }
      th {
        background: #e0e0e0;
      }
      input[type="number"] {
        width: 80px;
      }
      .chart-container {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 2rem;
        margin-top: 2rem;
      }
      .chart-box {
        flex: 1 1 300px;
        max-width: 400px;
        background: #fff;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }
      button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button.add {
        background-color: #4caf50;
        color: #fff;
      }
      button.export {
        background-color: #2196f3;
        color: #fff;
      }
      button.remove-row {
        background-color: #f44336;
        color: #fff;
      }
      button.import {
        background-color: #9c27b0;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <h1>Notenrechner</h1>
    <p>
      Tragen Sie für jedes Thema/Kapitel die Gesamtpunkte, die erreichten Punkte
      und das Gewicht ein. Neben der Verteilung der Gewichte wird zusätzlich
      ein Kreisdiagramm mit den tatsächlich erreichten Prozentwerten angezeigt.
    </p>
    <div class="actions">
      <button class="add" onclick="addRow()">Zeile hinzufügen</button>
      <button class="export" onclick="exportJson()">JSON exportieren</button>
      <!-- Neue Schaltfläche zum Exportieren als PDF -->
      <button class="export" onclick="exportPdf()">PDF exportieren</button>
      <label style="display: flex; align-items: center; gap: 0.5rem;">
        <input
          type="file"
          id="importFile"
          accept="application/json"
          style="display: none"
          onchange="importJson(event)"
        />
        <button class="import" onclick="document.getElementById('importFile').click()">
          JSON importieren
        </button>
      </label>
    </div>
    <table id="gradesTable">
      <thead>
        <tr>
          <th>Thema/Kapitel</th>
          <th>Erreichte Punkte</th>
          <th>Gesamtpunkte</th>
          <th>Gewicht (%)</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="chart-container">
      <div class="chart-box">
        <canvas id="weightChart"></canvas>
      </div>
      <div class="chart-box">
        <canvas id="percentChart"></canvas>
      </div>
    </div>
    <script>
      let weightChart;
      let percentChart;

      function addRow(data = {}) {
        const tableBody = document.querySelector('#gradesTable tbody');
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="text" value="${data.name || ''}" placeholder="Bezeichnung" /></td>
          <td><input type="number" min="0" step="0.01" value="${data.pointsAchieved ?? ''}" /></td>
          <td><input type="number" min="0" step="0.01" value="${data.pointsTotal ?? ''}" /></td>
          <td><input type="number" min="0" step="0.01" value="${data.weight ?? ''}" /></td>
          <td><button class="remove-row" onclick="removeRow(this)">Entfernen</button></td>
        `;
        tableBody.appendChild(row);
        updateCharts();
        // add event listeners to update chart on input change
        row.querySelectorAll('input').forEach((input) => {
          input.addEventListener('input', updateCharts);
        });
      }

      function removeRow(btn) {
        const row = btn.closest('tr');
        if (row) row.remove();
        updateCharts();
      }

      function getDataFromTable() {
        const rows = document.querySelectorAll('#gradesTable tbody tr');
        const data = [];
        rows.forEach((row) => {
          const cells = row.querySelectorAll('input');
          const name = cells[0].value.trim();
          const pointsAchieved = parseFloat(cells[1].value);
          const pointsTotal = parseFloat(cells[2].value);
          const weight = parseFloat(cells[3].value);
          if (!name) return; // skip empty names
          data.push({ name, pointsAchieved, pointsTotal, weight });
        });
        return data;
      }

      function updateCharts() {
        const data = getDataFromTable();
        const labels = data.map((d) => d.name);
        const weights = data.map((d) => (isNaN(d.weight) ? 0 : d.weight));
        const percentValues = data.map((d) => {
          if (isNaN(d.pointsAchieved) || isNaN(d.pointsTotal) || d.pointsTotal === 0) {
            return 0;
          }
          return (d.pointsAchieved / d.pointsTotal) * 100;
        });
        // update weight chart
        if (weightChart) weightChart.destroy();
        const weightCtx = document.getElementById('weightChart').getContext('2d');
        weightChart = new Chart(weightCtx, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [
              {
                data: weights,
                backgroundColor: generateColors(labels.length),
              },
            ],
          },
          options: {
            plugins: {
              title: {
                display: true,
                text: 'Gewichtsverteilung (in %)',
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || '';
                    const value = context.raw;
                    return `${label}: ${value}%`;
                  },
                },
              },
            },
          },
        });
        // update percent chart
        if (percentChart) percentChart.destroy();
        const percentCtx = document.getElementById('percentChart').getContext('2d');
        percentChart = new Chart(percentCtx, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [
              {
                data: percentValues,
                backgroundColor: generateColors(labels.length),
              },
            ],
          },
          options: {
            plugins: {
              title: {
                display: true,
                text: 'Tatsächliche erreichte Prozentwerte',
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || '';
                    const value = context.raw;
                    return `${label}: ${value.toFixed(2)} %`;
                  },
                },
              },
            },
          },
        });
      }

      function generateColors(count) {
        const colors = [];
        const baseColors = [
          '#f44336',
          '#2196f3',
          '#4caf50',
          '#ff9800',
          '#9c27b0',
          '#03a9f4',
          '#e91e63',
          '#8bc34a',
        ];
        for (let i = 0; i < count; i++) {
          colors.push(baseColors[i % baseColors.length]);
        }
        return colors;
      }

      function exportJson() {
        const data = getDataFromTable();
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        const dateStr = new Date().toISOString().split('T')[0];
        link.download = `notenrechner_${dateStr}.json`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
      }

      /**
       * Exportiert die aktuellen Daten und Diagramme als PDF.
       * Hierfür wird die Bibliothek jsPDF genutzt, die unter window.jspdf verfügbar ist.
       */
      function exportPdf() {
        const data = getDataFromTable();
        if (!window.jspdf) {
          alert('Fehler: jsPDF konnte nicht geladen werden.');
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        // Titel
        doc.setFontSize(16);
        doc.text('Notenrechner Übersicht', 10, 10);
        // Datenliste
        let y = 20;
        doc.setFontSize(12);
        data.forEach((item) => {
          const percent =
            isNaN(item.pointsAchieved) || isNaN(item.pointsTotal) || item.pointsTotal === 0
              ? 0
              : ((item.pointsAchieved / item.pointsTotal) * 100).toFixed(2);
          const line = `${item.name}: ${item.pointsAchieved} / ${item.pointsTotal} Punkte ( ${percent}% ), Gewicht: ${item.weight}%`;
          doc.text(line, 10, y);
          y += 7;
          // Falls die Seite voll ist, neue Seite
          if (y > 280) {
            doc.addPage();
            y = 20;
          }
        });
        // Diagramme auf neuen Seiten
        const weightImg = weightChart.toBase64Image();
        const percentImg = percentChart.toBase64Image();
        doc.addPage();
        doc.setFontSize(14);
        doc.text('Gewichtsverteilung (in %)', 10, 10);
        // Fügt das Kreisdiagramm hinzu und skaliert es auf 180 mm Breite
        doc.addImage(weightImg, 'PNG', 10, 20, 180, 90);
        doc.addPage();
        doc.text('Tatsächlich erreichte Prozentwerte', 10, 10);
        doc.addImage(percentImg, 'PNG', 10, 20, 180, 90);
        doc.save('notenrechner.pdf');
      }

      function importJson(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const json = JSON.parse(e.target.result);
            // Clear existing rows
            document.querySelector('#gradesTable tbody').innerHTML = '';
            // Validate and add rows
            if (Array.isArray(json)) {
              json.forEach((item) => {
                if (item && typeof item === 'object') {
                  addRow({
                    name: item.name || '',
                    pointsAchieved: item.pointsAchieved ?? '',
                    pointsTotal: item.pointsTotal ?? '',
                    weight: item.weight ?? '',
                  });
                }
              });
            } else {
              alert('JSON-Format ungültig. Erwartet wird ein Array von Objekten.');
            }
          } catch (err) {
            alert('Fehler beim Parsen der JSON-Datei: ' + err.message);
          }
          // reset file input so the same file can be selected again
          event.target.value = '';
          updateCharts();
        };
        reader.readAsText(file);
      }

      // Initial row
      addRow();
    </script>
    <!-- jsPDF zur Erstellung von PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </body>
</html>